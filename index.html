<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NAM COFFEE</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background-color: #f3f4f6;
    }
    .container-max { max-width: 1200px; margin: 0 auto; }
    .card { background: white; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .banner-text { opacity: 0; transform: translateY(30px); transition: all 1s ease; }
    .banner-loaded .banner-text { opacity: 1; transform: translateY(0); }
    .zalo-button {
      position: fixed; bottom: 20px; right: 20px; z-index: 9999;
      width: 60px; height: 60px; border-radius: 50%;
      background-color: #0084FF; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25); transition: all 0.3s ease; cursor: pointer;
    }
    .zalo-button:hover { transform: scale(1.1); box-shadow: 0 6px 14px rgba(0,0,0,0.3); }
    .zalo-button img { width: 35px; height: 35px; }
    .modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      display: none; align-items: center; justify-content: center; z-index: 10000;
    }

    /* D√≤ng ch·ªØ ch·∫°y NGANG d∆∞·ªõi menu */
    .banner-marquee {
      position: relative;
      overflow: hidden;
      background-color: rgba(0, 128, 0, 0.9);
      color: white;
      font-weight: 500;
      font-size: 0.9rem;
      white-space: nowrap;
      padding: 6px 0;
    }
    .banner-marquee span {
      display: inline-block;
      padding-left: 100%;
      animation: marquee 15s linear infinite;
    }
    @keyframes marquee {
      0% { transform: translateX(0%); }
      100% { transform: translateX(-100%); }
    }

    /* Th√¥ng b√°o nhanh ch·∫°y t·ª´ D∆Ø·ªöI L√äN TR√äN li√™n t·ª•c */
    #thongbaoMarquee {
      position: relative;
      height: 80px;
      overflow: hidden;
    }
    #thongbaoContent {
      position: absolute;
      bottom: 0;
      animation: scrollUp 8s linear infinite;
    }
    @keyframes scrollUp {
      0% { transform: translateY(100%); }
      100% { transform: translateY(-100%); }
    }

    #thongbaoContent p {
      margin: 0;
      padding: 2px 0;
    }

    /* Danh s√°ch th√†nh vi√™n styling */
    #memberList p {
      margin: 0;
      padding: 6px 0;
      border-bottom: 1px dashed #e5e7eb;
    }
    #memberList p:last-child { border-bottom: none; }

    /* Small responsive tweaks */
    @media (max-width: 1024px) {
      .container-max { padding-left: 12px; padding-right: 12px; }
    }

    /* Album styles */
    #gallery img { width: 100%; height: 180px; object-fit: cover; display: block; border-radius: 0.5rem; }
    .album-item { position: relative; }
    .delete-btn {
      position: absolute; top: 8px; right: 8px;
      background: rgba(255,255,255,0.9); border-radius: 6px; padding: 4px 6px; font-size: 12px;
      display: none;
    }
    .album-item:hover .delete-btn { display: block; }

    /* Lightbox */
    #lightbox {
      position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.85); z-index: 11000;
    }
    #lightbox img { max-width: 90%; max-height: 90%; border-radius: 8px; }
    #lightbox .close {
      position: absolute; top: 20px; right: 24px; color: white; font-size: 22px; cursor: pointer;
      background: rgba(0,0,0,0.4); padding: 6px 10px; border-radius: 6px;
    }
  </style>
</head>
<body>

  <!-- ======== BANNER ======== -->
<header class="relative overflow-hidden font-[Montserrat,sans-serif]">
  <!-- ·∫¢nh n·ªÅn -->
  <img src="https://i.ibb.co/TMwmmb0Z/NAM.png"
       alt="Banner l·ªõp 9.1"
       class="w-full h-40 md:h-52 object-cover brightness-75">

  <!-- L·ªõp ch·ªØ trong su·ªët tr√™n n·ªÅn -->
  <div class="absolute top-0 left-0 w-full h-full flex flex-col items-center justify-center bg-transparent text-center select-none">
    
    <!-- D√≤ng 1 -->
    <h1 class="text-3xl md:text-4xl font-extrabold uppercase tracking-wide
               text-amber-300 drop-shadow-[0_2px_4px_rgba(0,0,0,0.5)]">
      NAM COFFEE
    </h1>

    <!-- D√≤ng 2 -->
    <p class="text-lg md:text-xl font-semibold uppercase tracking-wide mt-2
              text-cyan-300 drop-shadow-[0_2px_4px_rgba(0,0,0,0.5)]">
      62 TR·∫¶N TH·ªä L√ù-THƒÇNG B√åNH-TP ƒê√Ä N·∫¥NG
    </p>
  </div>

  <!-- Font ch·ªØ ƒë·∫πp -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800&display=swap" rel="stylesheet">
</header>
  <!-- ======== MENU ======== -->
  <nav class="bg-green-600 text-white shadow-sm sticky top-0 z-40">
    <div class="container-max mx-auto px-4">
      <ul class="flex gap-6 py-3 font-semibold text-sm">
        <li><a href="#gioithieu" class="hover:underline" onclick="showSection('thongbao')">Gi·ªõi thi·ªáu</a></li>
        <li><a href="#thongbao" class="hover:underline" onclick="showSection('thongbao')">Th√¥ng b√°o</a></li>
        <li><a href="#album" class="hover:underline" onclick="showSection('thongbao')">Album ·∫£nh</a></li>
        <li><a href="#gopy" class="hover:underline" onclick="showSection('thongbao')">Form g√≥p √Ω</a></li>
        <li><a href="#lienhe" class="hover:underline" onclick="showSection('thongbao')">Li√™n h·ªá</a></li>
        <li><a href="#" class="hover:underline" onclick="showSection('thanhvien')">Th√†nh vi√™n</a></li>
        <li id="capnhatMenu" class="hidden"><a href="#" onclick="openUpdateModal()" class="hover:underline">C·∫≠p nh·∫≠t th√¥ng tin</a></li>
      </ul>
    </div>
  </nav>

  <!-- ======== D√íNG CH·ªÆ CH·∫†Y NGANG D∆Ø·ªöI MENU ======== -->
  <div class="banner-marquee w-full">
    <span>üåø Nam Coffee ! N∆°i th∆∞ gi·∫£n l√Ω t∆∞·ªüng, ph·ª•c v·ª• chu ƒë√°o, v·ªõi ph∆∞∆°ng ch√¢m Kh√°ch h√†ng l√† th∆∞·ª£ng ƒë·∫ø, m·ªçi g√≥p √Ω xin qu√Ω kh√°ch vui l√≤ng g·ªçi ho·∫∑c nh·∫Øn tin Zalo : 0964307247. üåø</span>
  </div>

  <!-- ======== MAIN ======== -->
  <main class="container-max mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-[260px_1fr_240px] gap-6">

    <!-- ==== C·ªòT TR√ÅI ==== -->
    <aside>
      <!-- ƒêƒÉng nh·∫≠p -->
      <div id="loginBox" class="card p-3">
        <h3 class="font-semibold text-green-700 mb-2 text-sm">üîê ƒêƒÉng nh·∫≠p</h3>
        <input id="loginEmail" type="email" placeholder="Email" class="w-full border p-1.5 rounded mb-1" />
        <input id="loginPass" type="password" placeholder="M·∫≠t kh·∫©u" class="w-full border p-1.5 rounded mb-2" />
        <div class="flex items-center mb-2">
          <input type="checkbox" id="rememberMe" class="mr-2">
          <label for="rememberMe" class="text-xs text-gray-700">L∆∞u th√¥ng tin ƒëƒÉng nh·∫≠p</label>
        </div>
        <button onclick="doLogin()" class="w-full bg-green-600 text-white py-1.5 rounded text-sm">ƒêƒÉng nh·∫≠p</button>
        <div class="flex justify-between text-xs mt-2">
          <button onclick="toggleRegisterForm()" class="text-gray-600 underline">ƒêƒÉng k√Ω t√†i kho·∫£n m·ªõi</button>
          <button onclick="resetPassword()" class="text-gray-600 underline">Qu√™n m·∫≠t kh·∫©u?</button>
        </div>
      </div>

      <!-- ƒêƒÉng k√Ω -->
      <div id="registerBox" class="card p-3 mt-3 hidden">
        <h3 class="font-semibold text-green-700 mb-2 text-sm">üìù ƒêƒÉng k√Ω t√†i kho·∫£n</h3>
        <input id="regName" type="text" placeholder="H·ªç v√† t√™n" class="w-full border p-1.5 rounded mb-1" />
        <input id="regEmail" type="email" placeholder="Email" class="w-full border p-1.5 rounded mb-1" />
        <input id="regPass" type="password" placeholder="M·∫≠t kh·∫©u (‚â•6 k√Ω t·ª±)" class="w-full border p-1.5 rounded mb-2" />
        <button onclick="doRegister()" class="w-full bg-blue-600 text-white py-1.5 rounded text-sm">ƒêƒÉng k√Ω</button>
        <button onclick="toggleRegisterForm()" class="mt-2 text-xs text-gray-600 underline">‚Üê Quay l·∫°i</button>
      </div>

      <!-- ƒê√£ ƒëƒÉng nh·∫≠p -->
      <div id="loggedBox" class="card p-3 mt-3 hidden text-sm">
        <div class="p-2 bg-gray-50 rounded mb-2" id="loggedInfo">Xin ch√†o <b>...</b></div>
        <button onclick="doLogout()" class="w-full bg-red-500 text-white py-1.5 rounded">ƒêƒÉng xu·∫•t</button>
      </div>

      <!-- Form g√≥p √Ω -->
      <div class="card p-3 mt-3 text-sm" id="gopySection">
        <h4 class="font-semibold text-green-700 mb-2">üí¨ Form g√≥p √Ω</h4>
        <div id="gopyFormArea">
          <textarea id="gopyText" rows="3" placeholder="Nh·∫≠p n·ªôi dung g√≥p √Ω..." class="w-full border rounded p-2 text-sm"></textarea>
          <button onclick="sendGopy()" class="mt-2 bg-green-600 text-white px-4 py-1.5 rounded text-sm w-full">G·ª≠i g√≥p √Ω</button>
        </div>
        <p id="loginToComment" class="hidden text-gray-500 text-xs">üîí Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ g·ª≠i g√≥p √Ω.</p>
      </div>
    </aside>

    <!-- ==== C·ªòT GI·ªÆA ==== -->
    <section class="space-y-6">
      <div id="thongbao" class="card p-4">
        <h2 class="text-lg font-bold text-green-700 mb-3">üì¢ Tin t·ª©c - Th√¥ng b√°o</h2>
        <div id="newsList" class="space-y-3 text-sm text-gray-500">ƒêang trong qu√° tr√¨nh ho√†n thi·ªán...</div>
      </div>

      <!-- ALBUM ·∫¢NH (m·ª•c m·ªõi ch√®n, gi·ªØ nguy√™n b·ªë c·ª•c v√† hi·ªÉn th·ªã khi b·∫•m Album ·∫£nh) -->
      <div id="album" class="card p-4 hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold text-green-700">üì∏ Album ·∫£nh</h2>
          <!-- N√∫t upload (ch·ªâ hi·ªán n·∫øu admin) -->
          <button id="uploadBtn" class="hidden bg-green-600 hover:bg-green-700 text-white px-4 py-1.5 rounded text-sm">
            + Th√™m ·∫£nh m·ªõi
          </button>
        </div>

        <!-- Gallery -->
        <div id="gallery" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
      </div>

      <!-- Danh s√°ch th√†nh vi√™n (·∫©n m·∫∑c ƒë·ªãnh) -->
      <div id="thanhvien" class="card p-4 hidden">
        <h2 class="text-lg font-bold text-green-700 mb-3">üìã Danh s√°ch th√†nh vi√™n l·ªõp 9/1</h2>
        <div id="memberList" class="space-y-1 text-sm text-gray-700">ƒêang t·∫£i danh s√°ch...</div>
      </div>

      <div class="card p-4">
        <h2 class="text-lg font-bold text-green-700 mb-3">üìú Danh s√°ch g√≥p √Ω</h2>
        <div id="gopyList" class="text-sm space-y-2"></div>
      </div>
    </section>

    <!-- ==== C·ªòT PH·∫¢I ==== -->
    <aside>
      <div class="card p-3 text-sm">
        <h3 class="font-semibold text-green-700 mb-2">Th√¥ng b√°o nhanh</h3>

        <!-- File Word ƒë·∫ßu ti√™n -->
        <a href="https://drive.google.com/uc?export=download&id=1hFk7S22K037r1espR1na2S45bGm-OTfS"
           class="mb-2 block bg-blue-600 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-700">
          üìÑ L·ªãch thi gi·ªØa h·ªçc k·ª≥ 1
        </a>

        <!-- Marquee vertical c√°c th√¥ng b√°o -->
        <div id="thongbaoMarquee">
          <div id="thongbaoContent">
            <p>‚úî M·ª´ng khai tr∆∞∆°ng gi·∫£m gi√° 10%</p>
            <p>‚úî Menu ƒëa d·∫°ng</p>
          </div>
        </div>
      </div>

      <div class="card p-3 mt-3 text-sm" id="lienhe">
        <h4 class="font-semibold text-green-700 mb-2">Li√™n h·ªá</h4>
        <p>Admin: <b>V√µ Qu·ªëc Thi√™n</b></p>
        <p>Email: <a href="mailto:contact@thcsleloi.vn" class="text-blue-600 hover:underline">contact@namcoffee.vn</a></p>
        <p>SƒêT: 0964 307 247</p>
      </div>
    </aside>
  </main>

  <footer class="container-max mx-auto px-4 py-4 text-center text-xs text-gray-600">
    ¬© 2025 L·ªõp 9.1 - THCS L√™ L·ª£i ‚Äî Thi·∫øt k·∫ø b·ªüi <b>NAM COFFEE</b>
  </footer>

  <!-- ======== FORM C·∫¨P NH·∫¨T TH√îNG TIN ======== -->
  <div id="updateModal" class="modal">
    <div class="bg-white rounded-lg p-6 w-80">
      <h3 class="text-lg font-semibold mb-3 text-green-700">üìù C·∫≠p nh·∫≠t th√¥ng tin</h3>
      <input id="upName" class="border rounded p-2 w-full mb-2 text-sm" placeholder="H·ªç v√† t√™n" />
      <input id="upPhone" class="border rounded p-2 w-full mb-2 text-sm" placeholder="S·ªë ƒëi·ªán tho·∫°i" />
      <input id="upBirth" class="border rounded p-2 w-full mb-2 text-sm" placeholder="Ng√†y sinh (dd/mm/yyyy)" />
      <input id="upAddress" class="border rounded p-2 w-full mb-3 text-sm" placeholder="ƒê·ªãa ch·ªâ" />
      <div class="flex justify-end gap-2">
        <button onclick="closeUpdateModal()" class="text-gray-600 text-sm">H·ªßy</button>
        <button onclick="saveUserInfo()" class="bg-green-600 text-white px-3 py-1 rounded text-sm">L∆∞u</button>
      </div>
    </div>
  </div>

  <!-- Lightbox for viewing images -->
  <div id="lightbox" onclick="closeLightbox()">
    <span class="close" onclick="closeLightbox(); event.stopPropagation();">‚úï</span>
    <img id="lightboxImage" src="" alt="Preview">
  </div>

  <!-- ======== ZALO BUTTON ======== -->
  <a href="https://zalo.me/0868670473" target="_blank" class="zalo-button" title="Chat qua Zalo">
    <img src="https://upload.wikimedia.org/wikipedia/commons/9/91/Icon_of_Zalo.svg" alt="Zalo">
  </a>

  <!-- Cloudinary widget (external script) -->
  <script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>

  <!-- ======== FIREBASE SCRIPT (gi·ªØ nguy√™n to√†n b·ªô ch·ª©c nƒÉng) ======== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, 
      sendPasswordResetEmail, signOut, onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
      getFirestore, doc, setDoc, getDoc, addDoc, deleteDoc, collection, 
      serverTimestamp, onSnapshot, query, orderBy, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDpFxMdzcS_X5upNyf2tOnt4Nx95UH7e1I",
      authDomain: "tracuuthcs-leloi.firebaseapp.com",
      projectId: "tracuuthcs-leloi",
      storageBucket: "tracuuthcs-leloi.firebasestorage.app",
      messagingSenderId: "305178645123",
      appId: "1:305178645123:web:46d1c907461d9e160a41b6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const adminEmail = "thien.miraeasset@gmail.com";

    let currentUser = null;

    // --- ƒêƒÇNG K√ù ---
    window.doRegister = async function() {
      const name = regName.value.trim();
      const email = regEmail.value.trim();
      const pass = regPass.value.trim();
      if (!name || !email || pass.length < 6) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!");
      try {
        const userCred = await createUserWithEmailAndPassword(auth, email, pass);
        await setDoc(doc(db, "users", userCred.user.uid), { name, email, approved: false, created: new Date() });
        alert("ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ch·ªù admin duy·ªát t√†i kho·∫£n.");
        toggleRegisterForm();
      } catch (e) { alert("L·ªói: " + e.message); }
    };

    // --- ƒêƒÇNG NH·∫¨P ---
    window.doLogin = async function() {
      try {
        const userCred = await signInWithEmailAndPassword(auth, loginEmail.value, loginPass.value);
        const userDoc = await getDoc(doc(db, "users", userCred.user.uid));
        if (!userDoc.exists() || !userDoc.data().approved) {
          await signOut(auth);
          return alert("T√†i kho·∫£n ch∆∞a ƒë∆∞·ª£c admin duy·ªát!");
        }
        currentUser = userCred.user;

        // L∆∞u th√¥ng tin ƒëƒÉng nh·∫≠p n·∫øu ch·ªçn checkbox
        if (rememberMe.checked) {
          localStorage.setItem("savedEmail", loginEmail.value);
          localStorage.setItem("savedPass", loginPass.value);
        } else {
          localStorage.removeItem("savedEmail");
          localStorage.removeItem("savedPass");
        }

        localStorage.setItem("userEmail", currentUser.email);
        localStorage.setItem("userName", userDoc.data().name || currentUser.email);

        loginBox.classList.add("hidden");
        loggedBox.classList.remove("hidden");
        loggedInfo.innerHTML = `Xin ch√†o <b>${userDoc.data().name || currentUser.email}</b>`;
        capnhatMenu.classList.remove("hidden");
        checkFormVisibility();
      } catch (e) { alert("Sai th√¥ng tin ho·∫∑c ch∆∞a ƒë∆∞·ª£c duy·ªát!"); }
    };

    // --- QU√äN M·∫¨T KH·∫®U ---
    window.resetPassword = async function() {
      const email = prompt("Nh·∫≠p email ƒë·ªÉ ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u:");
      if (!email) return;
      await sendPasswordResetEmail(auth, email);
      alert("H·ªá th·ªëng ƒë√£ g·ª≠i li√™n k·∫øt ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u t·ªõi email!");
    };

    // --- ƒêƒÇNG XU·∫§T ---
    window.doLogout = async function() {
      await signOut(auth);
      currentUser = null;
      localStorage.clear();
      loginBox.classList.remove("hidden");
      loggedBox.classList.add("hidden");
      capnhatMenu.classList.add("hidden");
      checkFormVisibility();
    };

    // --- G·ª¨I G√ìP √ù ---
    window.sendGopy = async function() {
      const content = gopyText.value.trim();
      if (!content) return alert("Vui l√≤ng nh·∫≠p n·ªôi dung!");
      const name = localStorage.getItem("userName") || "Ng∆∞·ªùi ·∫©n danh";
      const email = localStorage.getItem("userEmail") || "Kh√¥ng x√°c ƒë·ªãnh";
      await addDoc(collection(db, "gopy"), {
        name, email, content, created: serverTimestamp()
      });
      gopyText.value = "";
      alert("G√≥p √Ω ƒë√£ g·ª≠i th√†nh c√¥ng!");
    };

    // --- L·∫ÆNG NGHE G√ìP √ù ---
    const q = query(collection(db, "gopy"), orderBy("created", "desc"));
    onSnapshot(q, (snapshot) => {
      gopyList.innerHTML = "";
      snapshot.forEach((docu) => {
        const d = docu.data();
        const el = document.createElement("div");
        el.className = "border rounded p-2 bg-gray-50";
        el.innerHTML = `
          <div class="text-gray-700 text-sm"><b>${d.name}</b>: ${d.content}</div>
          ${localStorage.getItem("userEmail") === adminEmail
            ? `<button onclick="deleteGopy('${docu.id}')" class="text-xs text-red-500 mt-1 underline">X√≥a</button>` : ""
          }
        `;
        gopyList.appendChild(el);
      });
    });

    // --- X√ìA G√ìP √ù (admin) ---
    window.deleteGopy = async function(id) {
      const userEmail = localStorage.getItem("userEmail");
      if (userEmail !== adminEmail) return alert("Ch·ªâ admin m·ªõi ƒë∆∞·ª£c x√≥a g√≥p √Ω!");
      if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a g√≥p √Ω n√†y kh√¥ng?")) return;
      await deleteDoc(doc(db, "gopy", id));
      alert("ƒê√£ x√≥a g√≥p √Ω!");
    };

    // --- KI·ªÇM TRA FORM G√ìP √ù C√ì ƒê∆Ø·ª¢C HI·ªÇN TH·ªä KH√îNG ---
    function checkFormVisibility() {
      const user = localStorage.getItem("userEmail");
      if (user) {
        gopyFormArea.classList.remove("hidden");
        loginToComment.classList.add("hidden");
      } else {
        gopyFormArea.classList.add("hidden");
        loginToComment.classList.remove("hidden");
      }
    }

    // --- CHUY·ªÇN GI·ªÆA ƒêƒÇNG K√ù & ƒêƒÇNG NH·∫¨P ---
    window.toggleRegisterForm = function() {
      loginBox.classList.toggle("hidden");
      registerBox.classList.toggle("hidden");
    };

    // --- M·ªû / ƒê√ìNG MODAL C·∫¨P NH·∫¨T ---
    window.openUpdateModal = function() { updateModal.style.display = "flex"; };
    window.closeUpdateModal = function() { updateModal.style.display = "none"; };

    // --- L∆ØU TH√îNG TIN NG∆Ø·ªúI D√ôNG ---
    window.saveUserInfo = async function() {
      const u = auth.currentUser;
      if (!u) return alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!");
      await setDoc(doc(db, "users", u.uid), {
        name: upName.value, phone: upPhone.value,
        birth: upBirth.value, address: upAddress.value,
        email: u.email, approved: true
      }, { merge: true });
      alert("ƒê√£ l∆∞u th√¥ng tin!");
      closeUpdateModal();
    };

    // --- LOAD MEMBERS FROM FIRESTORE (gi·ªØ nguy√™n nh∆∞ng th√™m n√∫t x√≥a cho admin) ---
    async function loadMembers() {
      try {
        const memberListEl = document.getElementById('memberList');
        memberListEl.innerHTML = "<p>‚è≥ ƒêang t·∫£i danh s√°ch th√†nh vi√™n...</p>";
        const snap = await getDocs(collection(db, "users"));
        if (snap.empty) {
          memberListEl.innerHTML = "<p>Ch∆∞a c√≥ th√†nh vi√™n n√†o ƒëƒÉng k√Ω.</p>";
          return;
        }
        let i = 1;
        let html = "";
        const currentEmail = localStorage.getItem("userEmail");
        snap.forEach(docu => {
          const d = docu.data();
          const displayName = d.name && d.name.trim() !== "" ? d.name : (d.email || "Kh√¥ng r√µ");
          // n·∫øu user hi·ªán t·∫°i l√† admin, hi·ªÉn th·ªã n√∫t x√≥a k·∫ø b√™n (x√≥a theo uid)
          if (currentEmail === adminEmail) {
            html += `<p>${i++}. ${escapeHtml(displayName)} <button onclick="deleteMember('${docu.id}')" class="text-xs text-red-500 ml-2 underline">üóë X√≥a</button></p>`;
          } else {
            html += `<p>${i++}. ${escapeHtml(displayName)}</p>`;
          }
        });
        memberListEl.innerHTML = html;
      } catch (err) {
        document.getElementById('memberList').innerHTML = `<p>L·ªói khi t·∫£i danh s√°ch: ${err.message}</p>`;
        console.error("loadMembers error:", err);
      }
    }

    // --- X√ìA TH√ÄNH VI√äN (ADMIN) ---
    window.deleteMember = async function(uid) {
      const userEmail = localStorage.getItem("userEmail");
      if (userEmail !== adminEmail) return alert("Ch·ªâ admin m·ªõi ƒë∆∞·ª£c ph√©p x√≥a th√†nh vi√™n!");
      if (!confirm("X√°c nh·∫≠n x√≥a th√†nh vi√™n n√†y?")) return;
      try {
        await deleteDoc(doc(db, "users", uid));
        alert("ƒê√£ x√≥a th√†nh vi√™n!");
        loadMembers();
      } catch (err) {
        console.error("deleteMember error:", err);
        alert("X√≥a kh√¥ng th√†nh c√¥ng: " + err.message);
      }
    };

    // Escape HTML to avoid injection (simple)
    function escapeHtml(str) {
      if (!str) return "";
      return str.replace(/[&<>"']/g, function(m) {
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];
      });
    }

    // --- CHUY·ªÇN HI·ªÉn TH·ªä GI·ªÆA TH√îNG B√ÅO V√Ä TH√ÄNH VI√äN ---
    window.showSection = function(section) {
      const thongbao = document.getElementById('thongbao');
      const thanhvien = document.getElementById('thanhvien');
      const albumEl = document.getElementById('album');

      if (section === 'thanhvien' || section === 'members') {
        // ·∫©n th√¥ng b√°o, hi·ªán danh s√°ch th√†nh vi√™n
        if (thongbao) thongbao.classList.add('hidden');
        if (thanhvien) {
          thanhvien.classList.remove('hidden');
          loadMembers();
        }
      } else {
        // hi·ªán th√¥ng b√°o, ·∫©n danh s√°ch th√†nh vi√™n
        if (thanhvien) thanhvien.classList.add('hidden');
        if (thongbao) thongbao.classList.remove('hidden');
      }

      // NOTE: menu "Album ·∫£nh" trong file g·ªëc c√≥ onclick showSection('thongbao')
      // ƒë·ªÉ ƒë·∫£m b·∫£o ng∆∞·ªùi d√πng v·∫´n c√≥ th·ªÉ truy c·∫≠p album, n·∫øu anchor #album ƒë∆∞·ª£c click,
      // ch√∫ng ta c≈©ng hi·ªÉn th·ªã album: (kh√¥ng thay ƒë·ªïi h√†nh vi g·ªëc, ch·ªâ b·ªï sung)
      // N·∫øu c√≥ ph·∫ßn t·ª≠ album t·ªìn t·∫°i v√† location.hash === '#album', hi·ªÉn th·ªã album
      if (location.hash === "#album" && albumEl) {
        // ·∫©n th√¥ng b√°o v√† th√†nh vi√™n, hi·ªán album
        if (thongbao) thongbao.classList.add('hidden');
        if (thanhvien) thanhvien.classList.add('hidden');
        albumEl.classList.remove('hidden');
        loadAlbum(); // load album khi m·ªü
      } else {
        // n·∫øu album ƒëang hi·ªÉn th·ªã nh∆∞ng kh√¥ng ph·∫£i hash #album th√¨ ·∫©n (gi·ªØ h√†nh vi g·ªëc)
        if (albumEl && location.hash !== "#album") {
          albumEl.classList.add('hidden');
        }
      }
    };

    // --- KH·ªûI T·∫†O ---
    window.addEventListener("load", () => {
      document.body.classList.add("banner-loaded");
      const savedEmail = localStorage.getItem("savedEmail");
      const savedPass = localStorage.getItem("savedPass");
      if (savedEmail && savedPass) {
        loginEmail.value = savedEmail;
        loginPass.value = savedPass;
        rememberMe.checked = true;
      }
      checkFormVisibility();

      // N·∫øu l√∫c load trang ƒë√£ ·ªü #album, hi·ªÉn th·ªã album
      if (location.hash === "#album") {
        showSection('thongbao'); // gi·ªØ h√†nh vi g·ªçi showSection
        const albumEl = document.getElementById('album');
        if (albumEl) {
          albumEl.classList.remove('hidden');
          loadAlbum();
        }
      }

      // L·∫Øng nghe thay ƒë·ªïi auth ƒë·ªÉ c·∫≠p nh·∫≠t currentUser
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          currentUser = user;
          // l∆∞u email v√†o localStorage ƒë·ªÉ code kh√°c ki·ªÉm tra quy·ªÅn admin
          localStorage.setItem("userEmail", user.email);
          // n·∫øu admin th√¨ hi·ªÉn th·ªã n√∫t upload
          if (user.email === adminEmail) {
            const upl = document.getElementById('uploadBtn');
            if (upl) upl.classList.remove('hidden');
          }
        } else {
          currentUser = null;
          localStorage.removeItem("userEmail");
          const upl = document.getElementById('uploadBtn');
          if (upl) upl.classList.add('hidden');
        }
      });
    });

    // --- C√°c h√†m gi·ªØ nguy√™n trong file g·ªëc ƒë√£ c√≥ ·ªü tr√™n (ƒë√£ ch√®n, kh√¥ng thay ƒë·ªïi) ---
    // (ƒêo·∫°n code g·ªëc b·∫°n cung c·∫•p v·∫´n ƒë∆∞·ª£c gi·ªØ nguy√™n; m√¨nh ch·ªâ b·ªï sung h√†m loadMembers, deleteMember, escapeHtml v√† showSection)
    // ---------------------------------------------------------------------------------------
    // B·ªî SUNG: ALBUM ·∫¢NH (Cloudinary + Firestore) - l∆∞u link ·∫£nh v√†o Firestore, admin upload & delete
    // ---------------------------------------------------------------------------------------

    // Cloudinary config (theo th√¥ng tin b·∫°n ƒë√£ cung c·∫•p)
    const cloudName = "dhdmvqitk";
    const uploadPreset = "unsigned_upload";

    // T·∫°o widget Cloudinary (unsigned)
    const myWidget = cloudinary.createUploadWidget({
      cloudName: cloudName,
      uploadPreset: uploadPreset,
      sources: ['local', 'camera', 'url'],
      multiple: true,
      maxFiles: 20,
      folder: "album_lop9_1"
    }, async (error, result) => {
      if (!error && result && result.event === "success") {
        // L∆∞u link ·∫£nh v√†o Firestore
        try {
          await addDoc(collection(db, "album"), {
            url: result.info.secure_url,
            uploadedBy: currentUser ? currentUser.email : "unknown",
            createdAt: serverTimestamp()
          });
          // loadAlbum(); // onSnapshot s·∫Ω t·ª± c·∫≠p nh·∫≠t
          alert("‚úÖ ·∫¢nh ƒë√£ ƒë∆∞·ª£c t·∫£i l√™n v√† l∆∞u v√†o album!");
        } catch (err) {
          console.error("L·ªói l∆∞u album v√†o Firestore:", err);
          alert("L·ªói khi l∆∞u ·∫£nh v√†o h·ªá th·ªëng: " + err.message);
        }
      }
    });

    // M·ªü widget khi b·∫•m n√∫t upload (n√∫t ch·ªâ hi·ªÉn th·ªã n·∫øu admin)
    const uploadBtnEl = document.getElementById('uploadBtn');
    if (uploadBtnEl) {
      uploadBtnEl.addEventListener('click', () => {
        myWidget.open();
      });
    }

    // H√†m render 1 image v√†o gallery (d√πng b·ªüi onSnapshot)
    function renderImageItem(docId, data) {
      const gallery = document.getElementById('gallery');
      if (!gallery) return;
      const div = document.createElement('div');
      div.className = "album-item";
      div.dataset.id = docId;

      // Inner HTML with image and optional delete button (for admin)
      const currentEmail = localStorage.getItem("userEmail");
      const isAdminLocal = currentEmail === adminEmail;

      let inner = `
        <div class="relative rounded-xl overflow-hidden card">
          <img src="${data.url}" alt="·∫¢nh l·ªõp 9/1" loading="lazy" style="width:100%;height:180px;object-fit:cover;cursor:pointer;" onclick="openLightbox('${data.url}')" />
      `;

      if (isAdminLocal) {
        inner += `<button class="delete-btn" onclick="deleteImage('${docId}'); event.stopPropagation();">üóëÔ∏è X√≥a</button>`;
      }

      inner += `</div>`;

      div.innerHTML = inner;

      return div;
    }

    // Load album once (not necessary if using onSnapshot but useful)
    async function loadAlbum() {
      const gallery = document.getElementById('gallery');
      if (!gallery) return;
      gallery.innerHTML = `<p class="text-sm text-gray-500 col-span-full">‚è≥ ƒêang t·∫£i album...</p>`;
      try {
        const qAlbum = query(collection(db, "album"), orderBy("createdAt", "desc"));
        const snap = await getDocs(qAlbum);
        gallery.innerHTML = "";
        if (snap.empty) {
          gallery.innerHTML = `<p class="text-sm text-gray-500 col-span-full">Ch∆∞a c√≥ ·∫£nh trong album.</p>`;
          return;
        }
        snap.forEach(docu => {
          const el = renderImageItem(docu.id, docu.data());
          if (el) gallery.appendChild(el);
        });
      } catch (err) {
        console.error("loadAlbum error:", err);
        gallery.innerHTML = `<p class="text-sm text-red-500">L·ªói khi t·∫£i album: ${err.message}</p>`;
      }
    }

    // Real-time listener: khi collection 'album' thay ƒë·ªïi, c·∫≠p nh·∫≠t gallery
    (function subscribeAlbumRealtime() {
      try {
        const qAlbumSnap = query(collection(db, "album"), orderBy("createdAt", "desc"));
        onSnapshot(qAlbumSnap, (snapshot) => {
          const gallery = document.getElementById('gallery');
          if (!gallery) return;
          gallery.innerHTML = "";
          if (snapshot.empty) {
            gallery.innerHTML = `<p class="text-sm text-gray-500 col-span-full">Ch∆∞a c√≥ ·∫£nh trong album.</p>`;
            return;
          }
          snapshot.forEach(docu => {
            const el = renderImageItem(docu.id, docu.data());
            if (el) gallery.appendChild(el);
          });
        });
      } catch (err) {
        console.error("subscribeAlbumRealtime error:", err);
      }
    })();

    // X√≥a ·∫£nh (admin) - x√≥a document trong Firestore
    window.deleteImage = async function(docId) {
      const currentEmail = localStorage.getItem("userEmail");
      if (currentEmail !== adminEmail) {
        return alert("Ch·ªâ admin m·ªõi ƒë∆∞·ª£c x√≥a ·∫£nh!");
      }
      if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ·∫£nh n√†y kh·ªèi album?")) return;
      try {
        await deleteDoc(doc(db, "album", docId));
        alert("ƒê√£ x√≥a ·∫£nh kh·ªèi album!");
      } catch (err) {
        console.error("deleteImage error:", err);
        alert("X√≥a ·∫£nh kh√¥ng th√†nh c√¥ng: " + err.message);
      }
    };

    // Lightbox functions
    window.openLightbox = function(url) {
      const lb = document.getElementById('lightbox');
      const lbImg = document.getElementById('lightboxImage');
      if (lb && lbImg) {
        lbImg.src = url;
        lb.style.display = 'flex';
      }
    };
    window.closeLightbox = function() {
      const lb = document.getElementById('lightbox');
      const lbImg = document.getElementById('lightboxImage');
      if (lb && lbImg) {
        lb.style.display = 'none';
        lbImg.src = "";
      }
    };

    // ---------------------------------------------------------------------------------------
    // K·∫æT TH√öC PH·∫¶N ALBUM ·∫¢NH
    // ---------------------------------------------------------------------------------------

  </script>
</body>
</html>
